// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Models
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password      String
  role          String    @default("B2C") // B2C, B2B, ADMIN
  status        String    @default("ACTIVE") // ACTIVE, PENDING
  businessName  String?
  phone         String?
  address       String?
  discount      Float     @default(0) // B2B discount percentage
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  cart          CartItem[]
  b2bRequest    B2BRequest?
  addresses     ShippingAddress[]
}

model Product {
  id          String    @id @default(uuid())
  name        String
  description String
  images      String[]
  category    String
  features    String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  variants    ProductVariant[]
  cartItems   CartItem[]
  orderItems  OrderItem[]
}

model ProductVariant {
  id          String    @id @default(uuid())
  productId   String
  name        String    // e.g., "200g", "500g", "1kg"
  price       Float
  stock       Int
  sku         String    @unique
  
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]
  orderItems  OrderItem[]
}

model CartItem {
  id          String    @id @default(uuid())
  userId      String
  productId   String
  variantId   String
  quantity    Int
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, variantId])
}

model Order {
  id              String    @id @default(uuid())
  orderNumber     String    @unique
  userId          String
  status          String    @default("PENDING") // PENDING, PAID, PROCESSING, SHIPPED, DELIVERED, CANCELLED
  
  // Shipping Info
  shippingName    String
  shippingPhone   String
  shippingAddress String
  shippingCity    String
  shippingProvince String
  shippingCountry String    @default("Indonesia")
  shippingPostalCode String
  
  // Courier Info
  courierName     String
  courierService  String
  shippingCost    Float
  trackingNumber  String?
  isCustomShipping Boolean  @default(false)
  customShippingNote String?
  
  // Payment Info
  subtotal        Float
  discount        Float     @default(0)
  voucherCode     String?
  total           Float
  paymentMethod   String?
  paymentStatus   String    @default("UNPAID") // UNPAID, PAID, FAILED
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  cancellationReason String?
  
  user            User      @relation(fields: [userId], references: [id])
  items           OrderItem[]
  transaction     Transaction?
}

model Transaction {
  id              String    @id @default(uuid())
  orderId         String    @unique
  
  // Midtrans Data
  transactionId   String    @unique // Midtrans transaction_id
  orderNumber     String    // Same as Order.orderNumber
  paymentType     String?   // bank_transfer, echannel, credit_card, etc.
  grossAmount     Float
  transactionStatus String  @default("pending") // pending, settlement, expire, cancel, deny
  fraudStatus     String?   // accept, challenge, deny
  
  // Payment Details
  vaNumber        String?   // For bank transfer
  bank            String?   // BCA, BNI, Mandiri, etc.
  paymentCode     String?   // For convenience store
  billKey         String?   // For Mandiri Bill
  billerCode      String?   // For Mandiri Bill
  
  // Midtrans Response
  snapToken       String?   // For Snap payment
  snapRedirectUrl String?
  
  // Timestamps
  transactionTime DateTime?
  settlementTime  DateTime?
  expiryTime      DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderItem {
  id          String    @id @default(uuid())
  orderId     String
  productId   String
  variantId   String
  quantity    Int
  price       Float     // Price at time of order
  
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])
  variant     ProductVariant @relation(fields: [variantId], references: [id])
}

model Voucher {
  id          String    @id @default(uuid())
  code        String    @unique
  type        String    // PERCENTAGE, FIXED
  value       Float
  minPurchase Float     @default(0)
  maxDiscount Float?    // For percentage type
  quota       Int
  used        Int       @default(0)
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
}

model B2BRequest {
  id            String    @id @default(uuid())
  userId        String    @unique
  businessName  String
  phone         String
  address       String
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ShippingAddress {
  id          String    @id @default(uuid())
  userId      String
  label       String    // e.g., "Home", "Office"
  name        String
  phone       String
  address     String
  city        String
  province    String
  country     String    @default("Indonesia")
  postalCode  String
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Story {
  id          String    @id @default(uuid())
  title       String
  content     String    @db.Text
  imageUrl    String?
  isPublished Boolean   @default(false)
  order       Int       @default(0) // For sorting
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
